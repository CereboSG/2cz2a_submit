name: Auto-Approve File Uploads

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: write
  pull-requests: write

jobs:
  auto-approve:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Get changed files
        id: changed-files
        run: |
          # Get the list of changed files in the PR
          git fetch origin ${{ github.event.pull_request.base.ref }}
          CHANGED_FILES=$(git diff --name-only origin/${{ github.event.pull_request.base.ref }}...HEAD)
          echo "Changed files:"
          echo "$CHANGED_FILES"
          echo "files<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGED_FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Check file patterns
        id: check-files
        run: |
          # Define allowed file extensions and patterns
          # This mimics a file upload platform - all common submission file types are allowed
          ALLOWED_PATTERNS=(
            "\.py$"           # Python files
            "\.ipynb$"        # Jupyter notebooks
            "\.txt$"          # Text files
            "\.pdf$"          # PDF documents
            "\.md$"           # Markdown files
            "\.json$"         # JSON files
            "\.csv$"          # CSV files
            "\.xlsx?$"        # Excel files
            "\.docx?$"        # Word documents
            "\.pptx?$"        # PowerPoint files
            "\.zip$"          # Zip archives
            "\.png$"          # Images
            "\.jpe?g$"        # Images
            "\.gif$"          # Images
            "\.svg$"          # Images
            "\.html$"         # HTML files
            "\.css$"          # CSS files
            "\.js$"           # JavaScript files
            "\.sql$"          # SQL files
            "\.db$"           # Database files
            "\.sqlite3?$"     # SQLite databases
          )
          
          # Define protected paths that should never be auto-merged
          PROTECTED_PATHS=(
            "^\.github/"                # GitHub configuration
            "^\.git"                    # Git configuration
            "^LICENSE"                  # License file
            "^README\.md$"              # Main README
            "^AUTO_APPROVAL\.md$"       # Auto-approval docs
          )
          
          # Maximum file size in bytes (10MB)
          MAX_FILE_SIZE=10485760
          
          CHANGED_FILES="${{ steps.changed-files.outputs.files }}"
          ALL_ALLOWED=true
          
          # Check each changed file
          while IFS= read -r file; do
            if [ -z "$file" ]; then
              continue
            fi
            
            # Check if file is in protected path
            for protected in "${PROTECTED_PATHS[@]}"; do
              if echo "$file" | grep -qE "$protected"; then
                echo "✗ File is in protected path: $file"
                ALL_ALLOWED=false
                continue 2
              fi
            done
            
            # Check file size if file exists
            if [ -f "$file" ]; then
              FILE_SIZE=$(stat -f%z "$file" 2>/dev/null || stat -c%s "$file" 2>/dev/null || echo 0)
              if [ "$FILE_SIZE" -gt "$MAX_FILE_SIZE" ]; then
                echo "✗ File exceeds size limit ($(($FILE_SIZE / 1048576))MB): $file"
                ALL_ALLOWED=false
                continue
              fi
            fi
            
            # Check file extension
            FILE_ALLOWED=false
            for pattern in "${ALLOWED_PATTERNS[@]}"; do
              if echo "$file" | grep -qE "$pattern"; then
                FILE_ALLOWED=true
                echo "✓ File matches allowed pattern: $file"
                break
              fi
            done
            
            if [ "$FILE_ALLOWED" = false ]; then
              echo "✗ File does not match allowed patterns: $file"
              ALL_ALLOWED=false
            fi
          done <<< "$CHANGED_FILES"
          
          echo "all_allowed=$ALL_ALLOWED" >> $GITHUB_OUTPUT

      - name: Approve PR
        if: steps.check-files.outputs.all_allowed == 'true'
        run: |
          gh pr review ${{ github.event.pull_request.number }} --approve --body "✅ Auto-approved: All files match allowed patterns for submission."
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Enable auto-merge
        if: steps.check-files.outputs.all_allowed == 'true'
        run: |
          gh pr merge ${{ github.event.pull_request.number }} --auto --merge
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Comment on PR if files not allowed
        if: steps.check-files.outputs.all_allowed != 'true'
        run: |
          gh pr comment ${{ github.event.pull_request.number }} --body "⚠️ This PR cannot be auto-approved because:
          - Some files do not match allowed patterns (must be: .py, .ipynb, .txt, .pdf, etc.)
          - Files may be in protected paths (.github/, LICENSE, README.md)
          - Files may exceed the 10MB size limit
          
          Please ensure all files are valid submission types and review the [AUTO_APPROVAL.md](../blob/main/AUTO_APPROVAL.md) documentation."
        env:
          GH_TOKEN: ${{ github.token }}
